name: Build and Run Docker Container

on:
  push:
    branches:
      - "*"
  pull_request:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: self-hosted  

    steps:
  
      - name: Clean workspace and fix permissions
        run: |
          echo "Cleaning previous workspace..."
          sudo rm -rf ${{ github.workspace }}/*
          sudo mkdir -p ${{ github.workspace }}
          sudo chown -R $(whoami):$(whoami) ${{ github.workspace }}
          sudo chmod -R u+rwX ${{ github.workspace }}

      
      - name: Checkout repository
        uses: actions/checkout@v4

     
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

     
      - name: Build Docker image
        run: docker build -t cryptoimage:latest .

    
      - name: Run docker compose
        run: |
          docker compose up --build -d
          sleep 5
          docker ps

      
      - name: Check FastAPI health endpoint
        run: |
          curl -f http://localhost:8000 || (echo "FastAPI not responding!" && exit 1)


